name: PR Pipeline

on:
  pull_request:
    branches:
      - main

jobs:
  cloc:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install cloc
        run: sudo apt-get update && sudo apt-get install -y cloc
      
      - name: Count lines of code
        run: |
          cloc . --include-lang=JavaScript,CSS,HTML,SQL,Bourne\ Shell,Dockerfile,YAML --md > cloc_output.md
          cloc . --include-lang=JavaScript,CSS,HTML,SQL,Bourne\ Shell,Dockerfile,YAML
      
      - name: Count lines by committer
        run: |
          echo "## üë• Lines by Committer" > lines_by_committer.md
          echo "" >> lines_by_committer.md
          git log --format='%aN' | sort -u | while read author; do
            echo "### üë§ $author" >> lines_by_committer.md
            echo "" >> lines_by_committer.md
            
            # Overall statistics
            lines=$(git log --author="$author" --pretty=tformat: --numstat | awk '{ add += $1; subs += $2 } END { printf "%d additions, %d deletions", add, subs }')
            echo "**üìä Total**: $lines" >> lines_by_committer.md
            echo "" >> lines_by_committer.md
            
            # Breakdown by file type
            echo "**üìÅ Breakdown by file type**:" >> lines_by_committer.md
            for ext in js css html sql sh Dockerfile yaml yml; do
              case $ext in
                js) pattern="\.js$" label="üìú JavaScript" ;;
                css) pattern="\.css$" label="üé® CSS" ;;
                html) pattern="\.html$" label="üåê HTML" ;;
                sql) pattern="\.sql$" label="üóÑÔ∏è SQL" ;;
                sh) pattern="\.sh$" label="üêö Shell" ;;
                Dockerfile) pattern="Dockerfile" label="üê≥ Dockerfile" ;;
                yaml|yml) pattern="\.(yaml|yml)$" label="‚öôÔ∏è YAML" ;;
              esac
              
              type_lines=$(git log --author="$author" --pretty=tformat: --numstat | grep "$pattern" | awk '{ add += $1; subs += $2 } END { printf "%d additions, %d deletions", add, subs }')
              if [ ! -z "$type_lines" ] && [ "$type_lines" != "0 additions, 0 deletions" ]; then
                echo "- $label: $type_lines" >> lines_by_committer.md
              fi
            done
            echo "" >> lines_by_committer.md
          done
      
      - name: Display lines of code in summary
        run: |
          echo "## üìä Lines of Code Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat cloc_output.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat lines_by_committer.md >> $GITHUB_STEP_SUMMARY

  docker-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if only markdown files changed
        id: check_files
        run: |
          # Get list of changed files
          git fetch origin main
          changed_files=$(git diff --name-only origin/main...HEAD)
          echo "Changed files:"
          echo "$changed_files"
          
          # Check if all changed files are markdown
          non_md_files=$(echo "$changed_files" | grep -v '\.md$' || true)
          
          if [ -z "$non_md_files" ]; then
            echo "only_markdown=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Only markdown files changed - will skip Docker tests"
          else
            echo "only_markdown=false" >> $GITHUB_OUTPUT
            echo "üì¶ Non-markdown files changed - will run Docker tests"
          fi
      
      - name: Skip message
        if: steps.check_files.outputs.only_markdown == 'true'
        run: |
          echo "## ‚è≠Ô∏è Docker Tests Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Only markdown files were changed in this PR." >> $GITHUB_STEP_SUMMARY
          echo "Docker build and API tests have been skipped to save CI resources." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ This is expected behavior for documentation-only changes." >> $GITHUB_STEP_SUMMARY
      
      - name: Set up build dependencies
        if: steps.check_files.outputs.only_markdown != 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            docker-compose \
            curl \
            jq
          
          # Verify installations
          docker --version
          docker-compose --version
          curl --version
          jq --version
      
      - name: Create .env file
        if: steps.check_files.outputs.only_markdown != 'true'
        run: |
          cat > .env << EOF
          NODE_ENV=production
          POSTGRES_DB=cash_or_card
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          JWT_SECRET=test-secret-for-ci
          JWT_EXPIRES_IN=7d
          CORS_ORIGIN=http://localhost:3000
          EOF
      
      - name: Build and start Docker containers
        if: steps.check_files.outputs.only_markdown != 'true'
        run: |
          docker-compose up -d --build
          echo "Waiting for services to be healthy..."
          sleep 30
      
      - name: Check container status
        if: steps.check_files.outputs.only_markdown != 'true'
        run: |
          docker-compose ps
          docker-compose logs backend
      
      - name: Wait for backend to be ready
        if: steps.check_files.outputs.only_markdown != 'true'
        run: |
          echo "Waiting for backend to be ready..."
          max_attempts=30
          attempt=0
          until curl -f http://localhost:3001/health || [ $attempt -eq $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Attempt $attempt of $max_attempts..."
            sleep 2
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "Backend failed to become ready"
            docker-compose logs backend
            exit 1
          fi
          echo "Backend is ready!"
      
      - name: Test API endpoints
        if: steps.check_files.outputs.only_markdown != 'true'
        run: |
          # Create table header for summary
          echo "## üß™ API Test Results" > api_test_results.md
          echo "" >> api_test_results.md
          echo "| # | Test | Endpoint | Expected | Status |" >> api_test_results.md
          echo "|---|------|----------|----------|--------|" >> api_test_results.md
          
          # Test 1: Health check
          echo "=== Test 1: Health Check ==="
          response=$(curl -s -w "\n%{http_code}" http://localhost:3001/health)
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "Response body: $body"
          echo "Status code: $status_code"
          
          if [ "$status_code" -eq 200 ]; then
            echo "| 1 | üíì Health Check | \`GET /health\` | 200 | ‚úÖ Pass |" >> api_test_results.md
            echo "‚úÖ Health check passed"
          else
            echo "| 1 | üíì Health Check | \`GET /health\` | 200 | ‚ùå Fail |" >> api_test_results.md
            echo "‚ùå Health check failed"
            exit 1
          fi
          echo ""
          
          # Test 2: Get all restaurants (public endpoint)
          echo "=== Test 2: Get All Restaurants ==="
          response=$(curl -s -w "\n%{http_code}" http://localhost:3001/api/restaurants)
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "Response body (formatted):"
          echo "$body" | jq '.' || echo "$body"
          echo "Status code: $status_code"
          
          if [ "$status_code" -eq 200 ]; then
            echo "| 2 | üçΩÔ∏è Get Restaurants | \`GET /api/restaurants\` | 200 | ‚úÖ Pass |" >> api_test_results.md
            echo "‚úÖ GET /api/restaurants passed"
          else
            echo "| 2 | üçΩÔ∏è Get Restaurants | \`GET /api/restaurants\` | 200 | ‚ùå Fail |" >> api_test_results.md
            echo "‚ùå GET /api/restaurants failed"
            exit 1
          fi
          echo ""
          
          # Test 3: Register a new user
          echo "=== Test 3: User Registration ==="
          response=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3001/api/auth/register \
            -H "Content-Type: application/json" \
            -d '{"username":"testuser","email":"test@example.com","password":"TestPass123!"}')
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "Response body (formatted):"
          echo "$body" | jq '.' || echo "$body"
          echo "Status code: $status_code"
          
          if [ "$status_code" -eq 201 ] || [ "$status_code" -eq 200 ]; then
            echo "| 3 | üìù Register User | \`POST /api/auth/register\` | 201/200 | ‚úÖ Pass |" >> api_test_results.md
            echo "‚úÖ POST /api/auth/register passed"
          else
            echo "| 3 | üìù Register User | \`POST /api/auth/register\` | 201/200 | ‚ö†Ô∏è Skip |" >> api_test_results.md
            echo "‚ö†Ô∏è POST /api/auth/register returned status $status_code (may be expected if user exists)"
          fi
          echo ""
          
          # Test 4: User login
          echo "=== Test 4: User Login ==="
          response=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3001/api/auth/login \
            -H "Content-Type: application/json" \
            -d '{"email":"test@example.com","password":"TestPass123!"}')
          status_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)
          echo "Response body (formatted):"
          echo "$body" | jq '.' || echo "$body"
          echo "Status code: $status_code"
          
          if [ "$status_code" -eq 200 ]; then
            echo "| 4 | üîê User Login | \`POST /api/auth/login\` | 200 | ‚úÖ Pass |" >> api_test_results.md
            token=$(echo "$body" | jq -r '.token' 2>/dev/null || echo "")
            echo "‚úÖ POST /api/auth/login passed"
            echo "üéüÔ∏è Token received: ${token:0:20}..."
          else
            echo "| 4 | üîê User Login | \`POST /api/auth/login\` | 200 | ‚ùå Fail |" >> api_test_results.md
            echo "‚ùå POST /api/auth/login failed"
            token=""
          fi
          echo ""
          
          # Test 5: Create a new restaurant (authenticated)
          echo "=== Test 5: Create New Restaurant (Authenticated) ==="
          if [ ! -z "$token" ]; then
            response=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3001/api/restaurants \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $token" \
              -d '{
                "name": "Test Restaurant CI",
                "address": "123 CI Test Street",
                "city": "TestCity",
                "state": "TC",
                "zipCode": "12345",
                "phone": "555-0123",
                "cuisine": "Test Cuisine",
                "category": "Chinese",
                "cashDiscount": 5.0,
                "latitude": 40.7128,
                "longitude": -74.0060
              }')
            status_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | head -n-1)
            echo "Response body (formatted):"
            echo "$body" | jq '.' || echo "$body"
            echo "Status code: $status_code"
            
            if [ "$status_code" -eq 201 ] || [ "$status_code" -eq 200 ]; then
              echo "| 5 | üè™ Create Restaurant | \`POST /api/restaurants\` | 201/200 | ‚úÖ Pass |" >> api_test_results.md
              echo "‚úÖ POST /api/restaurants passed"
            else
              echo "| 5 | üè™ Create Restaurant | \`POST /api/restaurants\` | 201/200 | ‚ùå Fail |" >> api_test_results.md
              echo "‚ùå POST /api/restaurants failed"
              echo "Response: $body"
            fi
          else
            echo "| 5 | üè™ Create Restaurant | \`POST /api/restaurants\` | 201/200 | ‚ö†Ô∏è Skip |" >> api_test_results.md
            echo "‚ö†Ô∏è Skipped - no authentication token available"
          fi
          echo ""
          
          echo "‚ú® All critical API tests completed!"
      
      - name: Display API test results
        if: always() && steps.check_files.outputs.only_markdown != 'true'
        run: |
          echo "## üê≥ Docker Compose Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat api_test_results.md >> $GITHUB_STEP_SUMMARY
      
      - name: Cleanup
        if: always() && steps.check_files.outputs.only_markdown != 'true'
        run: |
          docker-compose logs
          docker-compose down -v