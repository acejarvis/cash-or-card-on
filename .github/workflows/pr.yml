name: PR Pipeline

on:
  pull_request:
    branches:
      - main

jobs:
  cloc:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install cloc
        run: sudo apt-get update && sudo apt-get install -y cloc
      
      - name: Count lines of code
        run: |
          cloc . --md > cloc_output.md
          cloc .
      
      - name: Count lines by committer
        run: |
          echo "## Lines by Committer" > lines_by_committer.md
          echo "" >> lines_by_committer.md
          git log --format='%aN' | sort -u | while read author; do
            lines=$(git log --author="$author" --pretty=tformat: --numstat | awk '{ add += $1; subs += $2 } END { printf "%d additions, %d deletions", add, subs }')
            echo "- **$author**: $lines" >> lines_by_committer.md
          done
      
      - name: Display lines of code in summary
        run: |
          echo "## Lines of Code Statistics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat cloc_output.md >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat lines_by_committer.md >> $GITHUB_STEP_SUMMARY